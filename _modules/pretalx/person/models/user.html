

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pretalx.person.models.user &mdash; pretalx 2024.4.0.dev0 documentation</title>
  
  <link rel="shortcut icon" href="../../../../_static/images/favicon.png"/>

  <link rel="stylesheet" href="../../../../_static/pretalx.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/css/pretalx.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  
  
    <link rel="index" title="Index" href="../../../../genindex.html"/>
    <link rel="search" title="Search" href="../../../../search.html"/>

   

  
  <script src="../../../../_static/js/modernizr.min.js"></script>
</head>

<body role="document">

   

  <header>
  <a id="logourl" href="/" class="mobile-hide">
    <img src="/_static/images/logo.svg" />
  </a>

  <div id="spacer"></div>
  <div role="search" id="header-search">
    <form id="rtd-search-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>

  <div id="related" class="mobile-hide">
    <div class="dropdown">
      <div class="dropdown-title">Support us</div>
      <div class="dropdown-body">
        <div class="dropdown-item"><a href="https://pretalx.com/p/pricing">Hosted pretalx</a></div>
        <div class="dropdown-item"><a href="https://pretalx.com/p/pricing">pretalx support</a></div>
        <div class="dropdown-item"><a href="https://rixx.de/funding">Developer support</a></div>
      </div>
    </div>
    <div class="dropdown">
      <div class="dropdown-title">Resources</div>
      <div class="dropdown-body">
        <div class="dropdown-item"><a href="https://pretalx.com/p/about/">Website</a></div>
        <div class="dropdown-item"><a href="https://pretalx.com/p/news/">Blog</a></div>
        <div class="dropdown-item"><a href="https://pretalx.com/p/try/">Try pretalx</a></div>
        <div class="dropdown-item"><a href="https://github.com/pretalx/pretalx/">Source code</a></div>
      </div>
    </div>
  </div>
</header>
    
    <nav data-toggle="nav-shift" class="nav-side">
      <div class="nav-scroll">

        <div class="nav-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
            <div id="toctree">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../administrator/index.html">Administrator documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/index.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../funding.html">‚ù§ Funding</a></li>
</ul>

            </div>
            
          
        </div>
      </div>
    </nav>

    <main data-toggle="nav-shift">

      
      <nav class="nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="nav-top" class="fa fa-bars"></i>
          <a href="../../../../contents.html">pretalx</a>
        
      </nav>

      
      <div class="nav-content">
        <div class="rst-content">
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pretalx.person.models.user</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">suppress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AbstractBaseUser</span><span class="p">,</span>
    <span class="n">BaseUserManager</span><span class="p">,</span>
    <span class="n">PermissionsMixin</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.contenttypes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.crypto</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_random_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.timezone</span><span class="w"> </span><span class="kn">import</span> <span class="n">now</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">override</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django_scopes</span><span class="w"> </span><span class="kn">import</span> <span class="n">scopes_disabled</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.authtoken.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Token</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_thumbnail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">TIMEZONE_CHOICES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.models.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileCleanupMixin</span><span class="p">,</span> <span class="n">GenerateCode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.text.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">path_with_hash</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_absolute_uri</span>


<span class="k">def</span><span class="w"> </span><span class="nf">avatar_path</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">code</span><span class="si">}{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">path_with_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="s2">&quot;avatars&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserManager</span><span class="p">(</span><span class="n">BaseUserManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The user manager class.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_administrator</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;is_staff&quot;</span><span class="p">,</span> <span class="s2">&quot;is_administrator&quot;</span><span class="p">,</span> <span class="s2">&quot;is_superuser&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">user</span>


<div class="viewcode-block" id="User">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">PermissionsMixin</span><span class="p">,</span> <span class="n">GenerateCode</span><span class="p">,</span> <span class="n">FileCleanupMixin</span><span class="p">,</span> <span class="n">AbstractBaseUser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The pretalx user model.</span>

<span class="sd">    Users describe all kinds of persons who interact with pretalx: Organisers, reviewers, submitters, speakers.</span>

<span class="sd">    :param code: A user&#39;s alphanumeric code is auto generated, may not be</span>
<span class="sd">        changed, and is the unique identifier of that user.</span>
<span class="sd">    :param name: A name fit for public display. Will be used in the user</span>
<span class="sd">        interface and for public display for all speakers in all of their</span>
<span class="sd">        events.</span>
<span class="sd">    :param password: The password is stored using Django&#39;s PasswordField. Use</span>
<span class="sd">        the ``set_password`` and ``check_password`` methods to interact with it.</span>
<span class="sd">    :param nick: The nickname field has been deprecated and is scheduled to be</span>
<span class="sd">        deleted. Use the email field instead.</span>
<span class="sd">    :param groups: Django internals, not used in pretalx.</span>
<span class="sd">    :param user_permissions: Django internals, not used in pretalx.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">EMAIL_FIELD</span> <span class="o">=</span> <span class="s2">&quot;email&quot;</span>
    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s2">&quot;email&quot;</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nick</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Please enter the name you wish to be displayed publicly. This name will be used for all events you are participating in on this server.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Email&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Your email address will be used for password resets and notification about your event/proposals.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Inactive users are not allowed to log in.&quot;</span>
    <span class="p">)</span>
    <span class="n">is_staff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;A default Django flag. Not in use in pretalx.&quot;</span>
    <span class="p">)</span>
    <span class="n">is_administrator</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Should only be ``True`` for people with administrative access to the server pretalx runs on.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">is_superuser</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Never set this flag to ``True``, since it short-circuits all authorisation mechanisms.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">LANGUAGES</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Preferred language&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[(</span><span class="n">tz</span><span class="p">,</span> <span class="n">tz</span><span class="p">)</span> <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="n">TIMEZONE_CHOICES</span><span class="p">],</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">avatar</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Profile picture&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;We recommend uploading an image at least 400px wide. &quot;</span>
            <span class="s2">&quot;A square image works best, as we display it in a circle in several places.&quot;</span>
        <span class="p">),</span>
        <span class="n">upload_to</span><span class="o">=</span><span class="n">avatar_path</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">avatar_thumbnail</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">upload_to</span><span class="o">=</span><span class="s2">&quot;avatars/&quot;</span><span class="p">)</span>
    <span class="n">avatar_thumbnail_tiny</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">upload_to</span><span class="o">=</span><span class="s2">&quot;avatars/&quot;</span>
    <span class="p">)</span>
    <span class="n">get_gravatar</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Retrieve profile picture via gravatar&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;If you have registered with an email address that has a gravatar account, we can retrieve your profile picture from there.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">avatar_source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Profile Picture Source&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Please enter the name of the author or source of image and a link if applicable.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">avatar_license</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Profile Picture License&quot;</span><span class="p">),</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Please enter the name of the license of the photo and link to it if applicable.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pw_reset_token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Password reset token&quot;</span>
    <span class="p">)</span>
    <span class="n">pw_reset_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Password reset time&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For public consumption as it is used for Select widgets, e.g. on the</span>
<span class="sd">        feedback form.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unnamed user&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permission_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_profile_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">team_permissions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cached_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">cached_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cached_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permission_cache</span><span class="p">[(</span><span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="User.get_display_name">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.get_display_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a user&#39;s name or &#39;Unnamed user&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Check if we need to get the profile picture from gravatar</span>
        <span class="n">update_gravatar</span> <span class="o">=</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;update_fields&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;get_gravatar&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;update_fields&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gravatar</span> <span class="ow">and</span> <span class="n">update_gravatar</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.person.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">gravatar_cache</span>

            <span class="n">gravatar_cache</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,),</span> <span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="User.event_profile">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.event_profile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">event_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve (and/or create) the event.</span>

<span class="sd">        :class:`~pretalx.person.models.profile.SpeakerProfile` for this user.</span>

<span class="sd">        :type event: :class:`pretalx.event.models.event.Event`</span>
<span class="sd">        :retval: :class:`pretalx.person.models.profile.EventProfile`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="p">(</span><span class="n">profile</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_profile_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pk</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">profile</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.person.models.profile</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpeakerProfile</span>

            <span class="n">profile</span> <span class="o">=</span> <span class="n">SpeakerProfile</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_profile_cache</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="k">return</span> <span class="n">profile</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_locale_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">locales</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span>
        <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">locale</span>

<div class="viewcode-block" id="User.log_action">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.log_action">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">person</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orga</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a log entry for this user.</span>

<span class="sd">        :param action: The log action that took place.</span>
<span class="sd">        :param data: Addition data to be saved.</span>
<span class="sd">        :param person: The person modifying this user. Defaults to this user.</span>
<span class="sd">        :type person: :class:`~pretalx.person.models.user.User`</span>
<span class="sd">        :param orga: Was this action initiated by a privileged user?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityLog</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">ActivityLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">person</span><span class="o">=</span><span class="n">person</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">,</span>
            <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">action_type</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">is_orga_action</span><span class="o">=</span><span class="n">orga</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">logged_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all log entries that were made about this user.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityLog</span>

        <span class="k">return</span> <span class="n">ActivityLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span>
            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">own_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all log entries that were made by this user.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.common.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityLog</span>

        <span class="k">return</span> <span class="n">ActivityLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the user by unsetting all of their information.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.submission.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Answer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;deleted_user_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">999</span><span class="p">)</span><span class="si">}</span><span class="s2">@localhost&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">email__iexact</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;deleted_user_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">99999</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Deleted User&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_administrator</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="s2">&quot;en&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_unusable_password</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">biography</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">person</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">question__contains_personal_data</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>
            <span class="n">answer</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># Iterate to delete answer files, too</span>
        <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">team</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">deactivate</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shred</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actually remove the user account.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.submission.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Submission</span>

        <span class="k">with</span> <span class="n">scopes_disabled</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">Submission</span><span class="o">.</span><span class="n">all_objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">speakers__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot delete user &lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&gt; because they have submissions, answers, or teams. Please deactivate this user instead.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_actions</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">own_actions</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_files</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="n">shred</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">guid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_URL</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;acct:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gravatar_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_avatar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar</span> <span class="o">!=</span> <span class="s2">&quot;False&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">avatar_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_avatar</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar</span><span class="o">.</span><span class="n">url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_avatar_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the full avatar URL, where user.avatar_url returns the</span>
<span class="sd">        absolute URL.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thumbnail</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">avatar_thumbnail_tiny</span>
                <span class="k">if</span> <span class="n">thumbnail</span> <span class="o">==</span> <span class="s2">&quot;tiny&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatar_thumbnail</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">create_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avatar</span><span class="p">,</span> <span class="n">thumbnail</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">custom_domain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">custom_domain</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_URL</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

<div class="viewcode-block" id="User.get_events_with_any_permission">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.get_events_with_any_permission">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_events_with_any_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a queryset of events for which this user has any type of</span>
<span class="sd">        permission.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.event.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_administrator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span>
                <span class="n">organiser_id__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_events</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                    <span class="s2">&quot;organiser&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;limit_events__id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="User.get_events_for_permission">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.get_events_for_permission">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_events_for_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a queryset of events for which this user as all of the given</span>
<span class="sd">        permissions.</span>

<span class="sd">        Permissions are given as named arguments, e.g.</span>
<span class="sd">        ``get_events_for_permission(is_reviewer=True)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.event.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_administrator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">orga_teams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">absolute</span> <span class="o">=</span> <span class="n">orga_teams</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_events</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
            <span class="s2">&quot;organiser&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">relative</span> <span class="o">=</span> <span class="n">orga_teams</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_events</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
            <span class="s2">&quot;limit_events&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">organiser__in</span><span class="o">=</span><span class="n">absolute</span><span class="p">)</span> <span class="o">|</span> <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span></div>


<div class="viewcode-block" id="User.get_permissions_for_event">
<a class="viewcode-back" href="../../../../developer/interfaces/models.html#pretalx.person.models.user.User.get_permissions_for_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_permissions_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a set of all permission a user has for the given event.</span>

<span class="sd">        :type event: :class:`~pretalx.event.models.event.Event`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_administrator</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;can_create_events&quot;</span><span class="p">,</span>
                <span class="s2">&quot;can_change_teams&quot;</span><span class="p">,</span>
                <span class="s2">&quot;can_change_organiser_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;can_change_event_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;can_change_submissions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;is_reviewer&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">teams</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">teams</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">members__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">teams</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">team</span><span class="o">.</span><span class="n">permission_set</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">teams</span><span class="p">])</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">regenerate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates a new API access token, deleting the old one.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;pretalx.user.token.reset&quot;</span><span class="p">)</span>
        <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">regenerate_token</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_password_reset_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orga</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;orga:event.auth.recover&quot;</span> <span class="k">if</span> <span class="n">orga</span> <span class="k">else</span> <span class="s2">&quot;cfp:event.recover&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">build_absolute_uri</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_token</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">slug</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">build_absolute_uri</span><span class="p">(</span>
                <span class="s2">&quot;orga:auth.recover&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_token</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mail_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orga</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.mail.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueuedMail</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_token</span> <span class="o">=</span> <span class="n">get_random_string</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_time</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_password_reset_url</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">orga</span><span class="o">=</span><span class="n">orga</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mail_text</span><span class="p">:</span>
            <span class="n">mail_text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Hi {name},</span>

<span class="sd">you have requested a new password for your pretalx account.</span>
<span class="sd">To reset your password, click on the following link:</span>

<span class="sd">  {url}</span>

<span class="sd">If this wasn‚Äôt you, you can just ignore this email.</span>

<span class="sd">All the best,</span>
<span class="sd">the pretalx robot&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="n">override</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">):</span>
            <span class="n">QueuedMail</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password recovery&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mail_text</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">),</span>
                <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
                <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pretalx.user.password.reset&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">orga</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">reset_password</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_password</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pretalx.mail.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueuedMail</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_reset_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mail_text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Hi {name},</span>

<span class="sd">Your pretalx account password was just changed.</span>

<span class="sd">If you did not change your password, please contact the site administration immediately.</span>

<span class="sd">All the best,</span>
<span class="sd">the pretalx team&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">override</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">):</span>
            <span class="n">QueuedMail</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;[pretalx] Password changed&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mail_text</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">),</span>
                <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
                <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;pretalx.user.password.changed&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">change_password</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span></div>

</pre></div>

           </div>
          </div>
          <footer>
  
    <a href="https://github.com/pretalx/pretalx/blob/main/doc/_modules/pretalx/person/models/user" class="fa fa-github"> Edit this page</a> &middot;
  
  &copy; Copyright 2017-2025, Tobias Kunze.
  <div> 
  </div>
</footer>
        </div>
      </div>
    </main>

  <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:'../../../../',
          VERSION:'2024.4.0.dev0',
          COLLAPSE_INDEX:false,
          FILE_SUFFIX:'.html',
          HAS_SOURCE:  true,
          SOURCELINK_SUFFIX: '.txt'
      };
  </script>
    <script type="text/javascript" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../../_static/clipboard.min.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script> 

</body>
</html>